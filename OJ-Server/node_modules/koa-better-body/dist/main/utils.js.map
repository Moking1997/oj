{"version":3,"sources":["utils.js"],"names":["defaultOptions","options","cfg","types","defaultTypes","extendTypes","opts","fields","files","multipart","textLimit","formLimit","jsonLimit","jsonStrict","detectJSON","bufferLimit","buffer","strict","delimiter","decodeURIComponent","querystring","unescape","maxKeys","sep","urlencodedLimit","onError","onЕrror","onerror","handler","noopHandler","allTypes","text","form","json","isValid","method","includes","toUpperCase","setParsers","ctx","app","qs","request","bind","thunk","done","fileFields","IncomingForm","formidable","on","name","file","push","field","hasOwnProperty","Array","isArray","parse","req","parseBody","next","custom","length","is","call","urlencoded","res","body","limit","result"],"mappings":"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","sourcesContent":["import extend from 'extend-shallow';\nimport formidable from 'formidable';\nimport querystring from 'querystring';\nimport bodyParsers from 'koa-body-parsers';\n\n/**\n * > Default options that will be loaded. Pass `options` to overwrite them.\n *\n * @param  {Object} `options`\n * @return {Object}\n * @api private\n */\nexport function defaultOptions(options = {}) {\n  const cfg = { ...options };\n\n  const types = defaultTypes(cfg.extendTypes);\n  const opts = extend(\n    {\n      fields: false,\n      files: false,\n      multipart: true,\n      textLimit: false,\n      formLimit: false,\n      jsonLimit: false,\n      jsonStrict: true,\n      detectJSON: false,\n      bufferLimit: false,\n      buffer: false,\n      strict: true,\n\n      // query string `parse` options\n      delimiter: '&',\n      decodeURIComponent: querystring.unescape,\n      maxKeys: 1000,\n    },\n    cfg,\n  );\n\n  opts.delimiter = opts.sep || opts.delimiter;\n  opts.formLimit = opts.formLimit || opts.urlencodedLimit;\n  opts.extendTypes = types;\n  opts.onError = opts.onЕrror || opts.onerror;\n  opts.onError = typeof opts.onError === 'function' ? opts.onError : false;\n\n  opts.delimiter = typeof opts.delimiter === 'string' ? opts.delimiter : '&';\n\n  if (typeof opts.handler !== 'function') {\n    // eslint-disable-next-line no-empty-function\n    opts.handler = function* noopHandler() {};\n  }\n  if (typeof opts.detectJSON !== 'function') {\n    opts.detectJSON = function detectJSON() {\n      return false;\n    };\n  }\n\n  return opts;\n}\n\n/**\n * > Only extend/overwrite default accept types.\n *\n * @param  {Object} `types`\n * @return {Object}\n * @api private\n */\nexport function defaultTypes(types = {}) {\n  const allTypes = { ...types };\n\n  return extend(\n    {\n      multipart: ['multipart/form-data'],\n      text: ['text/*'],\n      form: ['application/x-www-form-urlencoded'],\n      json: [\n        'application/json',\n        'application/json-patch+json',\n        'application/vnd.api+json',\n        'application/csp-report',\n      ],\n      buffer: ['text/*'],\n    },\n    allTypes,\n  );\n}\n\n/**\n * > Is \"valid\" request method, according to IETF Draft.\n *\n * @see   https://tools.ietf.org/html/draft-ietf-httpbis-p2-semantics-19#section-6.1\n * @param  {String} `method` koa request method\n * @return {Boolean}\n * @api private\n */\nexport function isValid(method) {\n  return !['GET', 'HEAD', 'DELETE'].includes(method.toUpperCase());\n}\n\n/**\n * > Add `koa-body-parsers` to the koa context. In addition\n * also adds the formidable as multipart parser.\n *\n * @param  {Object} `ctx` koa context\n * @param  {Object} `opts` default options\n * @return {Object} `ctx` koa context\n * @api private\n */\nexport function setParsers(ctx, opts) {\n  ctx.app.querystring =\n    opts.querystring ||\n    opts.qs || // alias\n    (ctx.app && ctx.app.querystring) ||\n    (ctx.app && ctx.app.qs) || // alias\n    ctx.qs; // alias\n\n  bodyParsers(ctx);\n\n  // to do: when using koa-body-parsers v3.1 - it adds support for this and\n  // probably will break us in some way.\n  // delete ctx.request.body;\n\n  ctx.request.multipart = multipart.bind(ctx);\n  return ctx;\n}\n\n/**\n * > Formidable wrapper as multipart parser to make\n * thunk that later can be yielded. Also allows you to pass\n * formidable.IncomingForm instance to `options.IncomingForm`.\n *\n * @param  {Object} `options` passed or default plugin options\n * @param  {Object} `ctx` koa context\n * @return {Function} thunk\n * @api private\n */\nexport function multipart(opts) {\n  const ctx = this;\n\n  return function thunk(done) {\n    const fields = {};\n    const fileFields = {};\n    const files = [];\n    const form =\n      opts.IncomingForm instanceof formidable.IncomingForm\n        ? opts.IncomingForm\n        : new formidable.IncomingForm(opts);\n\n    form.on('error', done);\n    form.on('aborted', done);\n    form.on('file', (name, file) => {\n      files.push(file);\n      fileFields[name] = fileFields[name] || [];\n      fileFields[name].push(file);\n    });\n    form.on('field', (name, field) => {\n      // eslint-disable-next-line no-prototype-builtins\n      if (fields.hasOwnProperty(name)) {\n        if (Array.isArray(fields[name])) {\n          fields[name].push(field);\n        } else {\n          fields[name] = [fields[name], field];\n        }\n      } else {\n        fields[name] = field;\n      }\n    });\n    form.on('end', () => {\n      done(null, {\n        fields: { ...fields, ...fileFields },\n        files,\n      });\n    });\n    form.parse(ctx.req);\n  };\n}\n\n/**\n * > Parse a different type of request bodies. By default accepts\n * and can parse JSON, JSON-API, JSON-Patch, text, form, urlencoded\n * and buffer bodies.\n *\n * @param {Object}   `ctx` koa context\n * @param {Object}   `options` plugin options\n * @param {Function} `next` next middleware\n * @api private\n */\n\n// eslint-disable-next-line max-statements, consistent-return\nexport function* parseBody(ctx, options, next) {\n  const fields = typeof options.fields === 'string' ? options.fields : 'fields';\n  const files = typeof options.files === 'string' ? options.files : 'files';\n  const { custom } = options.extendTypes;\n\n  if (custom && custom.length > 0 && ctx.request.is(custom)) {\n    yield* options.handler.call(ctx, ctx, options, next);\n    return yield* next;\n  }\n  if (options.detectJSON(ctx) || ctx.request.is(options.extendTypes.json)) {\n    ctx.app.jsonStrict =\n      typeof options.jsonStrict === 'boolean' ? options.jsonStrict : true;\n    ctx.request[fields] = yield ctx.request.json(options.jsonLimit);\n    return yield* next;\n  }\n  if (\n    ctx.request.is(options.extendTypes.form || options.extendTypes.urlencoded)\n  ) {\n    const res = yield ctx.request.urlencoded(options.formLimit);\n    ctx.request[fields] = res;\n    return yield* next;\n  }\n  if (options.buffer && ctx.request.is(options.extendTypes.buffer)) {\n    ctx.request.body = yield ctx.request.buffer(options.bufferLimit);\n    return yield* next;\n  }\n  if (ctx.request.is(options.extendTypes.text)) {\n    const limit = options.textLimit;\n    const body = yield ctx.request.text(limit);\n\n    ctx.request.body = body;\n    return yield* next;\n  }\n  if (options.multipart && ctx.request.is(options.extendTypes.multipart)) {\n    const result = yield ctx.request.multipart(options);\n    ctx.request[fields] = result.fields;\n    ctx.request[files] = result.files;\n    return yield* next;\n  }\n}\n"]}